<html>
<head>
<title>ThreatConnect Javascript SDK</title>

<!--
<script src="./libs/uuid.js" type="text/javascript"></script>
<script type="text/javascript" src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
-->

<!-- JQuery -->
<script type="text/javascript" src="https://code.jquery.com/jquery-2.1.4.min.js"></script>

<!-- Bootstrap -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.9.1/bootstrap-table.min.css">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.9.1/bootstrap-table.min.js"></script>

<!-- X-Editable -->
<link href="//cdnjs.cloudflare.com/ajax/libs/x-editable/1.5.0/bootstrap3-editable/css/bootstrap-editable.css" rel="stylesheet"/>
<script src="//cdnjs.cloudflare.com/ajax/libs/x-editable/1.5.0/bootstrap3-editable/js/bootstrap-editable.min.js"></script>

<!-- LeafLet -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.0.0-beta.2.rc.2/leaflet.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.0.0-beta.2.rc.2/leaflet.js"></script>

<!-- HMAC -->
<script src="./libs/core.js" type="text/javascript"></script>
<script src="./libs/sha256.js" type="text/javascript"></script>
<script src="./libs/hmac.js" type="text/javascript"></script>
<script src="./libs/enc-base64.js" type="text/javascript"></script>

<!-- ThreatConnect -->
<script src="./threatconnect.js" type="text/javascript"></script>

</head>

<body>

    <nav class="navbar navbar-default navbar-static-top">
        <div class="container-fluid">
            <div class="navbar-header">
                <a class="navbar-brand" href="#">TC JavaScript Tester</a>
            </div>
            <div>
                <ul class="nav navbar-nav">
                    <li class="active">
                        <a data-toggle="tab" href="#Api-pane">API Request</a>
                    </li>
                    <li><a data-toggle="tab" href="#Adversary-pane">
                            Adversaries <span class="label label-success label-as-badge"></span>
                    </a></li>
                    <li><a data-toggle="tab" href="#Document-pane">
                        Documents <span class="label label-success label-as-badge"></span>
                    </a></li>
                    <li><a data-toggle="tab" href="#Email-pane">
                        Emails <span class="label label-success label-as-badge"></span>
                    </a></li>
                    <li><a data-toggle="tab" href="#Group-pane">
                        Groups <span class="label label-success label-as-badge"></span>
                    </a></li> 
                    <li><a data-toggle="tab" href="#Incident-pane">
                        Incidents <span class="label label-success label-as-badge"></span>
                    </a></li> 
                    <li><a data-toggle="tab" href="#Indicator-pane">
                        Indicators <span class="label label-success label-as-badge"></span>
                    </a></li> 
                    <li><a data-toggle="tab" href="#Owner-pane">Owners </a></li> 
                </ul>
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <form class="navbar-form navbar-right navbar-input-group" role="search">
                            <div class="form-group">
                                <label for="Owner-select">Owner</label>
                                <select class="form-control" id="Owner-select">
                                </select>
                            </div>
                        </form>
                    </li> 
                </ul>
            </div>
        </div>
    </nav>
    
    <div id="alert-status"></div>
    
    <div class="tab-content">
        
        <div class="tab-pane active" id="Api-pane">
            <div class="panel panel-default">
                <div class="panel-body">
                    <h3>API URI</h3>
                    <div class="input-group">
                        <input type="input" class="form-control" id="api-uri">
                        <div class="input-group-btn">
                            <button type="button"
                                    class="btn btn-default dropdown-toggle"
                                    data-toggle="dropdown"
                                    aria-haspopup="true"
                                    aria-expanded="false">
                                Action<span class="caret"></span>
                            </button>
                            <ul id="api-method" class="dropdown-menu">
                                <li><a href="#">GET</a></li>
                                <li><a href="#">POST</a></li>
                                <li><a href="#">PUT</a></li>
                                <!--
                                <li role="separator" class="divider"></li>
                                -->
                                <li><a href="#">DELETE</a></li>
                            </ul>
                        </div>
                    </div>
                    <h3>Post/Put Body</h3>
                    <div class="form-group">
                        <textarea class="form-control" rows="5" id="api-body"></textarea>
                    </div>
                </div>
            </div>
            <div class="panel panel-primary">
                <div class="panel-body">
                    <h3>Results:</h3>
                    <pre id="api-content"></pre>
                </div>
            </div>
        </div>
        
        <div class="tab-pane" id="Adversary-pane" data="Adversary" data-id="#Adversary-table">
            <div class="panel panel-default">
                <div class="panel-body">
        
                    <ul class="nav nav-tabs">
                        <li class="active"><a data-toggle="tab" href="#Adversary-table-tab">Data Table</a></li>
                        <li><a data-toggle="tab" href="#Adversary-raw">Raw Data</a></li>
                    </ul>
                    <div class="tab-content">
                        
                        <div id="Adversary-table-tab" class="tab-pane fade in active">
                            <table id="Adversary-table"
                                   data-cache="false"
                                   data-height="543"
                                   data-search="true"
                                   data-striped="true"
                                   data-select-item-name="toolbar1"
                                   data-toggle="table"
                                   data-toolbar="#Adversary-toolbar"
                                   data-pagination="true"
                                   data-show-columns="true"
                                   data-show-refresh="false"
                                   data-show-toggle="true"
                                   data-sort-name="id"
                                   data-sort-order="desc">
                                <thead>
                                    <tr>
                                        <th data-field="state" data-checkbox="true">Item ID</th>
                                        <th data-field="id" data-align="right" data-sortable="true">ID</th>
                                        <th data-field="name" data-align="center" data-sortable="true">Name</th>
                                        <th data-field="ownerName" data-align="center">Owner</th>
                                        <th data-field="dateAdded" data-align="center">Date Added</th>
                                        <th data-field="webLink" data-align="center">Web Link</th>
                                    </tr>
                                </thead>
                            </table>
                        </div>
        
                        <div id="Adversary-toolbar" class="btn-group pull-right">
                            <button type="button" class="btn btn-default" data-toggle="modal" data-target="#Adversary-modal">Add</button>
                            <button type="button" class="btn btn-danger" id="Adversary-delete">Delete</button>
                            <button type="button" class="btn btn-default" id="Adversary-clear">Clear</button>
                            <button type="button" class="btn btn-default" id="Adversary-refresh">Refresh</button>
                            <button type="button" class="btn btn-default" data-toggle="modal" data-target="#Association-modal">Associations</button>
                            <!--
                            <button type="button" class="btn btn-default">Attributes</button>
                            <button type="button" class="btn btn-default">Tags</button>
                            -->
                        </div>
        
                        <div id="Adversary-raw" class="tab-pane fade">
                            <pre id="Adversary-content"></pre>
                        </div>
                        
                    </div>
                </div>
            </div>
        </div>
        
        <div class="tab-pane" id="Document-pane" data="Document" data-id="#Document-table">
            <div class="panel panel-default">
                <div class="panel-body">
        
                    <ul class="nav nav-tabs">
                        <li class="active"><a data-toggle="tab" href="#Document-table-tab">Data Table</a></li>
                        <li><a data-toggle="tab" href="#Document-raw">Raw Data</a></li>
                    </ul>
                    <div class="tab-content">
                        
                        <div id="Document-table-tab" class="tab-pane fade in active">
                            <table id="Document-table"
                                   data-cache="false"
                                   data-height="543"
                                   data-search="true"
                                   data-striped="true"
                                   data-select-item-name="toolbar1"
                                   data-toggle="table"
                                   data-toolbar="#Document-toolbar"
                                   data-pagination="true"
                                   data-show-columns="true"
                                   data-show-refresh="false"
                                   data-show-toggle="true"
                                   data-sort-name="id"
                                   data-sort-order="desc">
                                <thead>
                                    <tr>
                                        <th data-field="state" data-checkbox="true">Item ID</th>
                                        <th data-field="id" data-align="right" data-sortable="true">ID</th>
                                        <th data-field="name" data-align="center" data-sortable="true">Name</th>
                                        <th data-field="ownerName" data-align="center">Owner</th>
                                        <th data-field="dateAdded" data-align="center">Date Added</th>
                                        <th data-field="webLink" data-align="center">Web Link</th>
                                    </tr>
                                </thead>
                                <input type="file" class="hide" id="Document-file"></input>
                            </table>
                        </div>
        
                        <div id="Document-toolbar" class="btn-group pull-right">
                            <button type="button" class="btn btn-default" data-toggle="modal" data-target="#Document-modal">Add</button>
                            <button type="button" class="btn btn-danger" id="Document-delete">Delete</button>
                            <button type="button" class="btn btn-default" id="Document-clear">Clear</button>
                            <button type="button" class="btn btn-default" id="Document-refresh">Refresh</button>
                            <button type="button" class="btn btn-primary" id="Document-upload">Upload</button>
                            <!--
                            <button type="button" class="btn btn-default">Attributes</button>
                            <button type="button" class="btn btn-default">Tags</button>
                            -->
                        </div>
        
                        <div id="Document-raw" class="tab-pane fade">
                            <pre id="Document-content"></pre>
                        </div>
                        
                    </div>
                </div>
            </div>
        </div>
        
        <div class="tab-pane" id="Email-pane" data="Email" data-id="#Email-table">
            <div class="panel panel-default">
                <div class="panel-body">
        
                    <ul class="nav nav-tabs">
                        <li class="active"><a data-toggle="tab" href="#Email-table-tab">Data Table</a></li>
                        <li><a data-toggle="tab" href="#Email-raw">Raw Data</a></li>
                    </ul>
                    <div class="tab-content">
                        
                        <div id="Email-table-tab" class="tab-pane fade in active">
                            <table id="Email-table"
                                   data-cache="false"
                                   data-height="543"
                                   data-search="true"
                                   data-striped="true"
                                   data-select-item-name="toolbar1"
                                   data-toggle="table"
                                   data-toolbar="#Email-toolbar"
                                   data-pagination="true"
                                   data-show-columns="true"
                                   data-show-refresh="false"
                                   data-show-toggle="true"
                                   data-sort-name="id"
                                   data-sort-order="desc">
                                <thead>
                                    <tr>
                                        <th data-field="state" data-checkbox="true">Item ID</th>
                                        <th data-field="id" data-align="right" data-sortable="true">ID</th>
                                        <th data-field="name" data-align="center" data-sortable="true">Name</th>
                                        <th data-field="ownerName" data-align="center">Owner</th>
                                        <th data-field="dateAdded" data-align="center">Date Added</th>
                                        <th data-field="webLink" data-align="center">Web Link</th>
                                    </tr>
                                </thead>
                                <input type="file" class="hide" id="Email-file"></input>
                            </table>
                        </div>
        
                        <div id="Email-toolbar" class="btn-group pull-right">
                            <button type="button" class="btn btn-default" data-toggle="modal" data-target="#Email-modal">Add</button>
                            <button type="button" class="btn btn-danger" id="Email-delete">Delete</button>
                            <button type="button" class="btn btn-default" id="Email-clear">Clear</button>
                            <button type="button" class="btn btn-default" id="Email-refresh">Refresh</button>
                            <!--
                            <button type="button" class="btn btn-default">Attributes</button>
                            <button type="button" class="btn btn-default">Tags</button>
                            -->
                        </div>
        
                        <div id="Email-raw" class="tab-pane fade">
                            <pre id="Email-content"></pre>
                        </div>
                        
                    </div>
                </div>
            </div>
        </div>
        
        <div class="tab-pane" id="Group-pane" data="Group" data-id="#Group-table">
            <div class="panel panel-default">
                <div class="panel-body">
        
                    <ul class="nav nav-tabs">
                        <li class="active"><a data-toggle="tab" href="#Group-table-tab">Data Table</a></li>
                        <li><a data-toggle="tab" href="#Group-raw">Raw Data</a></li>
                    </ul>
                    <div class="tab-content">
                        
                        <div id="Group-table-tab" class="tab-pane fade in active">
                            <table id="Group-table"
                                   data-cache="false"
                                   data-height="543"
                                   data-search="true"
                                   data-striped="true"
                                   data-select-item-name="toolbar1"
                                   data-toggle="table"
                                   data-toolbar="#Group-toolbar"
                                   data-pagination="true"
                                   data-show-columns="true"
                                   data-show-refresh="false"
                                   data-show-toggle="true"
                                   data-sort-name="id"
                                   data-sort-order="desc">
                                <thead>
                                    <tr>
                                        <th data-field="state" data-checkbox="true">Item ID</th>
                                        <th data-field="id" data-align="right" data-sortable="true">ID</th>
                                        <th data-field="name" data-align="center" data-sortable="true">Name</th>
                                        <th data-field="type" data-align="center" data-sortable="true">Type</th>
                                        <th data-field="ownerName" data-align="center">Owner</th>
                                        <th data-field="dateAdded" data-align="center">Date Added</th>
                                        <th data-field="webLink" data-align="center">Web Link</th>
                                    </tr>
                                </thead>
                            </table>
                        </div>
        
                        <div id="Group-toolbar" class="btn-group pull-right">
                            <button type="button" class="btn btn-default" id="Group-clear">Clear</button>
                            <button type="button" class="btn btn-default" id="Group-refresh">Refresh</button>
                            <button type="button" class="btn btn-default" data-toggle="modal" data-target="#Group-map-modal">
                                Association Map
                            </button>
                            <!--
                            <button type="button" class="btn btn-default">Attributes</button>
                            <button type="button" class="btn btn-default">Tags</button>
                            -->
                        </div>
        
                        <div id="Group-raw" class="tab-pane fade">
                            <pre id="Group-content"></pre>
                        </div>
                        
                    </div>
                </div>
            </div>
        </div>
        
        <div class="tab-pane" id="Incident-pane" data="Incident" data-id="#Incident-table">
            <div class="panel panel-default">
                <div class="panel-body">
        
                    <ul class="nav nav-tabs">
                        <li class="active"><a data-toggle="tab" href="#Incident-table-tab">Data Table</a></li>
                        <li><a data-toggle="tab" href="#Incident-raw">Raw Data</a></li>
                    </ul>
                    <div class="tab-content">
                        
                        <div id="Incident-table-tab" class="tab-pane fade in active">
                            <table id="Incident-table"
                                   data-cache="false"
                                   data-height="543"
                                   data-search="true"
                                   data-striped="true"
                                   data-select-item-name="toolbar1"
                                   data-toggle="table"
                                   data-toolbar="#Incident-toolbar"
                                   data-pagination="true"
                                   data-show-columns="true"
                                   data-show-refresh="false"
                                   data-show-toggle="true"
                                   data-sort-name="id"
                                   data-sort-order="desc">
                                <thead>
                                    <tr>
                                        <th data-field="state" data-checkbox="true">Item ID</th>
                                        <th data-field="id" data-align="right" data-sortable="true">ID</th>
                                        <th data-field="name" data-align="center" data-sortable="true">Name</th>
                                        <th data-field="ownerName" data-align="center">Owner</th>
                                        <th data-field="dateAdded" data-align="center">Date Added</th>
                                        <th data-field="webLink" data-align="center">Web Link</th>
                                    </tr>
                                </thead>
                            </table>
                        </div>
        
                        <div id="Incident-toolbar" class="btn-group pull-right">
                            <button type="button" class="btn btn-default" data-toggle="modal" data-target="#Incident-modal">Add</button>
                            <button type="button" class="btn btn-danger" id="Incident-delete">Delete</button>
                            <button type="button" class="btn btn-default" id="Incident-clear">Clear</button>
                            <button type="button" class="btn btn-default" id="Incident-refresh">Refresh</button>
                            <!--
                            <button type="button" class="btn btn-default">Attributes</button>
                            <button type="button" class="btn btn-default">Tags</button>
                            -->
                        </div>
        
                        <div id="Incident-raw" class="tab-pane fade">
                            <pre id="Incident-content"></pre>
                        </div>
                        
                    </div>
                </div>
            </div>
        </div>
        
        <div class="tab-pane" id="Indicator-pane" data="Indicator" data-id="#Indicator-table">
            <div class="panel panel-default">
                <div class="panel-body">
        
                    <ul class="nav nav-tabs">
                        <li class="active"><a data-toggle="tab" href="#Indicator-table-tab">Data Table</a></li>
                        <li><a data-toggle="tab" href="#Indicator-raw">Raw Data</a></li>
                        <li><a data-toggle="tab" href="#map-tab">(IP/Host) Map</a></li>
                    </ul>
                    <div class="tab-content">
                        
                        <div id="Indicator-table-tab" class="tab-pane fade in active">
                            <table id="Indicator-table"
                                   data-cache="false"
                                   data-height="543"
                                   data-search="true"
                                   data-striped="true"
                                   data-select-item-name="toolbar1"
                                   data-toggle="table"
                                   data-toolbar="#Indicator-toolbar"
                                   data-pagination="true"
                                   data-show-columns="true"
                                   data-show-refresh="false"
                                   data-show-toggle="true"
                                   data-sort-name="id"
                                   data-sort-order="desc">
                                <thead>
                                    <tr>
                                        <th data-field="state" data-checkbox="true">Item ID</th>
                                        <th data-field="id" data-align="right" data-sortable="true">ID</th>
                                        <th data-field="indicators" data-align="center" data-sortable="true">Indicators</th>
                                        <th data-field="rating" data-align="center" data-sortable="true">Rating</th>
                                        <th data-field="confidence" data-align="center" data-sortable="true">Confidence</th>
                                        <th data-field="type" data-align="center" data-sortable="true">Type</th>
                                        <th data-field="ownerName" data-align="center">Owner</th>
                                        <th data-field="dateAdded" data-align="center">Date Added</th>
                                        <th data-field="lastModified" data-align="center">Last Modified</th>
                                        <th data-field="webLink" data-align="center" data-visible="false">Web Link</th>
                                    </tr>
                                </thead>
                            </table>
        
                            <div id="Indicator-toolbar" class="btn-group pull-right">
                                <button type="button" class="btn btn-default" data-toggle="modal" data-target="#Indicator-modal">Add</button>
                                <button type="button" class="btn btn-danger" id="Indicator-delete">Delete</button>
                                <button type="button" class="btn btn-default" id="Indicator-clear">Clear</button>
                                <button type="button" class="btn btn-default" id="Indicator-refresh">Refresh</button>
                                <!--
                                <button type="button" class="btn btn-default">Attributes</button>
                                <button type="button" class="btn btn-default">Tags</button>
                                -->
                            </div>
                        </div>
        
                        <div id="Indicator-raw" class="tab-pane fade">
                            <pre id="Indicator-content"></pre>
                        </div>
                        
                        <div id="map-tab" class="tab-pane fade">
                            <div class="container fill">
                                <div id="map"></div> 
                            </div>
                        </div>
                        
                    </div>
                </div>
            </div>
        </div>
        
        <div class="tab-pane" id="Owner-pane" data="Owner" data-id="#Owner-table">
            <div class="panel panel-default">
                <div class="panel-body">
        
                    <ul class="nav nav-tabs">
                        <li class="active"><a data-toggle="tab" href="#Owner-table-tab">Data Table</a></li>
                        <li><a data-toggle="tab" href="#Owner-raw">Raw Data</a></li>
                    </ul>
                    <div class="tab-content">
                        
                        <div id="Owner-table-tab" class="tab-pane fade in active">
                            <table id="Owner-table"
                                   data-cache="false"
                                   data-height="543"
                                   data-search="true"
                                   data-striped="true"
                                   data-select-item-name="toolbar1"
                                   data-toggle="table"
                                   data-toolbar="#Owner-toolbar"
                                   data-pagination="true"
                                   data-show-columns="true"
                                   data-show-refresh="false"
                                   data-show-toggle="true"
                                   data-sort-name="id"
                                   data-sort-order="desc">
                                <thead>
                                    <tr>
                                        <th data-field="state" data-checkbox="true">Item ID</th>
                                        <th data-field="id" data-align="right" data-sortable="true">ID</th>
                                        <th data-field="name" data-align="center" data-sortable="true">Name</th>
                                        <th data-field="type" data-align="center">Type</th>
                                    </tr>
                                </thead>
                            </table>
        
                            <div id="Owner-toolbar" class="btn-group pull-right">
                                <button type="button" class="btn btn-default" id="Owner-clear">Clear</button>
                                <button type="button" class="btn btn-default" id="Owner-refresh">Refresh</button>
                                <!--
                                <button type="button" class="btn btn-default">Attributes</button>
                                <button type="button" class="btn btn-default">Tags</button>
                                -->
                            </div>
                        </div>
                        
                        <div id="Owner-raw" class="tab-pane fade">
                            <pre id="Owner-content"></pre>
                        </div>
                        
                    </div>
                </div>
            </div>
        </div>
        
    </div>

    <!-- Modals -->
    
    <div id="Adversary-modal" class="modal fade" role="dialog">
        <div class="modal-dialog modal-lg">
    
            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Add Adversary</h4>
                </div>
                <div class="modal-body">
                    <form role="form">
                        <div class="form-group">
                            <label for="Adversary-name">Adversary Name</label>
                            <input type="input" class="form-control" id="Adversary-name">
                        </div>
                        <button id="Adversary-commit" type="submit" class="btn btn-default">Submit</button>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
            </div>
    
        </div>
    </div>
    
    <div id="Document-modal" class="modal fade" role="dialog">
        <div class="modal-dialog modal-lg">
    
            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Add Document</h4>
                </div>
                <div class="modal-body">
                    <form role="form">
                        <div class="form-group">
                            <label for="Document-name">Document Name</label>
                            <input type="input" class="form-control" id="Document-name">
                        </div>
                        <div class="form-group">
                            <label for="file-name">File Name</label>
                            <input type="input" class="form-control" id="file-name">
                        </div>
                        <div class="form-group">
                            <label for="file-size">File Size</label>
                            <input type="input" class="form-control" id="file-size">
                        </div>
                        <button id="Document-commit" type="submit" class="btn btn-default">Submit</button>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
            </div>
    
        </div>
    </div>
    
    <div id="Email-modal" class="modal fade" role="dialog">
        <div class="modal-dialog modal-lg">
    
            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Add Email</h4>
                </div>
                <div class="modal-body">
                    <form role="form">
                        <div class="form-group">
                            <label for="Email-name">Email Name</label>
                            <input type="input" class="form-control" id="Email-name">
                        </div>
                        <div class="form-group">
                            <label for="Email-body">Body</label>
                            <input type="input" class="form-control" id="Email-body">
                        </div>
                        <div class="form-group">
                            <label for="Email-from">From Address</label>
                            <input type="input" class="form-control" id="Email-from">
                        </div>
                        <div class="form-group">
                            <label for="Email-header">Header</label>
                            <input type="input" class="form-control" id="Email-header">
                        </div>
                        <div class="form-group">
                            <label for="Email-score">Score</label>
                            <input type="input" class="form-control" id="Email-score">
                        </div>
                        <div class="form-group">
                            <label for="Email-subject">Subject</label>
                            <input type="input" class="form-control" id="Email-subject">
                        </div>
                        <div class="form-group">
                            <label for="Email-to">To</label>
                            <input type="input" class="form-control" id="Email-to">
                        </div>
                        <button id="Email-commit" type="submit" class="btn btn-default">Submit</button>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
            </div>
    
        </div>
    </div>
    
    <div id="Incident-modal" class="modal fade" role="dialog">
        <div class="modal-dialog modal-lg">
    
            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Add Incident</h4>
                </div>
                <div class="modal-body">
                    <form role="form">
                        <div class="form-group">
                            <label for="Incident-name">Incident Name</label>
                            <input type="input" class="form-control" id="Incident-name">
                        </div>
                        <button id="Incident-commit" type="submit" class="btn btn-default">Submit</button>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
            </div>
    
        </div>
    </div>
    
    <div id="Indicator-modal" class="modal fade" role="dialog">
        <div class="modal-dialog modal-lg">
    
            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Add Indicator</h4>
                </div>
                <div class="modal-body">
                    <form role="form">
                        <div class="form-group">
                            <label for="Indicator-value">Indicator</label>
                            <input type="input" class="form-control" id="Indicator-value">
                        </div>
                        <div class="form-group">
                            <label for="Indicator-type">Indicator Type</label>
                            <select id="Indicator-type" class="form-control">
                                <option>ADDRESS</option>
                                <option>EMAIL_ADDRESS</option>
                                <option>FILE</option>
                                <option>HOST</option>
                                <option>URL</option>
                            </select>
                        </div>
                        <button id="Indicator-commit" type="submit" class="btn btn-default">Submit</button>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
            </div>
    
        </div>
    </div>
        
    <div id="Group-map-modal" class="modal fade" role="dialog">
        <div class="modal-dialog modal-lg">
    
            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">Association Map</h4>
                </div>
                <div class="modal-body">
                    <div id="Group-map"></div> 
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
            </div>
    
        </div>
    </div>
        
    <div id="Association-modal" class="modal fade" role="dialog">
        <div class="modal-dialog modal-lg">
    
            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">Association</h4>
                </div>
                <div class="modal-body">
                    <pre id="Association-content"></pre> 
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
            </div>
    
        </div>
    </div>
    
</body>

<style>
#Group-map
{
    width: 100px;
    height: 600px;
    min-height: 500px;
    min-width: 100%;
    display: block;
}
.modal-body {
    max-height: 600px;
}


#map
{
    width: 100px;
    height: 80px;
    min-height: 80%;
    min-width: 100%;
    display: block;
}
/*html, body*/
/*{*/
/*    height: 100%;*/
/*}*/
/*.fill*/
/*{*/
/*    min-height: 90%;*/
/*    height: 90%;*/
/*    width: 100%;*/
/*    min-width: 100%;*/
/*}*/

.label-as-badge {
    border-radius: 1em;
}
    
</style>

<script>
    /* global getParameterByName, getParameterFromUri, L, map, RequestObject, ThreatConnect, TYPE */
    
    var apiSettings,
        c = console;
        // spaces mode if spaceElementId defined
        var tcSpaceElementId = getParameterByName('tcSpaceElementId');
        if ( tcSpaceElementId ) {
            c.log('tcSpaceElementId Found.');
            apiSettings = {
                apiToken: getParameterByName('tcToken'),
                apiUrl: getParameterByName('tcApiPath')
            };
        } else {
            c.log('tcSpaceElementId NOT Found.');
            apiSettings = {
                apiId: '80139273637620589570',
                apiSec: 'TCpl5xUATf6Hw$kP8KUajwX?0H8BmqeqnimIB7q95df8Eay?%LkLsEQ0eFT1nXQw',
                apiUrl: 'https://ti.sumx.us/api'
            };
        }
        
    var tc = new ThreatConnect(apiSettings);
    
    //turn to inline mode
    // $.fn.editable.defaults.mode = 'inline';
    $.fn.editable.defaults.mode = 'popup';
    
    // Badge Counts
    resourceCounts('v2/groups/adversaries', 'Adversary');
    resourceCounts('v2/groups/documents', 'Document');
    resourceCounts('v2/groups/emails', 'Email');
    resourceCounts('v2/groups', 'Group');
    resourceCounts('v2/groups/incidents', 'Incident');
    retrieveIndicatorCount('Indicator');
    // resourceCounts('v2/indicators', 'Indicator');
        
    // Set select owner options
    tc.owners()
        .done(function(response) {
            var owner,
                selected = 'selected';
            for (owner in response.data) {   
                $('#Owner-select')
                    .append($('<option ' + selected + '></option>')
                    .attr('value', response.data[owner].name)
                    .text(response.data[owner].name)); 
                selected = '';
            }
        })
        .error(function(response) {
            var message =  'Owner Retrieval failed. (' + response + ').';
            statusAlert('danger', message);
        })
        .retrieve();
        
    // Owner Select
    $('#Owner-select').change(function() {
        var active_tab = $('.tab-content > .active').not('.fade').attr('data');
        c.log('changed', active_tab);
        $('#' + active_tab + '-table').bootstrapTable('removeAll');
        var retrieve = window['retrieve' + active_tab];
        retrieve();
    });
        
    // Modal Hide
    $('.modal').on('hidden.bs.modal', function(){
        var modalId = $(this).attr('id');
        if (modalId === 'Group-map-modal') {
            groupMap.remove();
        } else if (modalId === 'Association-modal') {
            
        } else {
            $(this).find('form')[0].reset();
        }
    });
    
    // Modal Show     
    $('.modal').on('show.bs.modal', function(){
        var modalId = $(this).attr('id');
        if (modalId === 'Association-modal') {
            retrieveAssociations({
                groupType: TYPE.ADVERSARY,
                type: TYPE.GROUP
            });
        } else if (modalId === 'Group-map-modal') {
            
        }
    });
    
    $('#Group-map-modal').on('show.bs.modal', function(){
        c.log('map modal shown');
        var group_table = $('#Group-table'),
            selections =  group_table.bootstrapTable('getSelections');
            
        groupMap = createMap('Group-map');
            
        if (selections.length == 0) {
            c.warn('at least one document must be selected.');
            
            setTimeout(function() {
                c.log('close map modal');
                $('#Group-map-modal').modal('hide');
            }, 200);
            
            return;
        } else if (selections.length > 1) {
            c.warn('only one upload at a time is supported.');
            group_table.bootstrapTable('uncheckAll');
            
            setTimeout(function() {
                c.log('close map modal');
                $('#Group-map-modal').modal('hide');
            }, 200);
            
            return;
        }
        
        var types = {
            Adversary: 'adversaries'
        };
        
        var retrieveObj = {
            id:    selections[0].id,
            type:  types[selections[0].type]
        };
        c.log('retrieveObj', retrieveObj);
        
        // get group associations
        tc.groups()
            .owner($('#Owner-select :selected').text())
            .resultLimit(500)
            .pagination(function(response) {
                c.log('response', response);
                for (data in response.data) {
                    if (response.data[data].type == 'Address') {
                        var ip = response.data[data].indicators;
                        geoIpUrl =  'https://www.telize.com/geoip/' + ip + '?callback=?';
                        
	                    $.getJSON(geoIpUrl, function() {
	                        console.log("success");
	                    })
	                    .always(function(data) {
	                        console.log("complete", data);
	                        if (data.latitude && data.longitude) {
	                            L.marker([data.latitude, data.longitude]).addTo(groupMap)
                                    .bindPopup(data.ip)
                                    .openPopup();
                            }
	                    });
                    }
                }
            })
            .done(function(response) {
            })
            .error(function(response) {
                var message =  'Group Retrieval failed. (' + response + ').';
                statusAlert('danger', message);
            })
            .retrieve(retrieveObj);
        
        setTimeout(function() {
            c.log('invalidate size');
            groupMap.invalidateSize();
        }, 200);
    });
    
    // Tab Hide
    $('a[data-toggle="tab"]').on('hide.bs.tab', function (e) {
        console.log('e', $($(e.target).attr('href')).data('id'));
        var prevTab = $(e.target).attr('href'),
            prevId = $(prevTab).data('id');
        c.log('prevId', prevId);
        $(prevId).bootstrapTable('removeAll');
    });
    
    // Tab Show
    $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
        
        c.log('tab', $(this).attr('href'));
        
        // var active_tab = $('#BCS').find('.tab-pane.active');
        // var active_tab = $('.tab-content > .tab-pane.active').data('id');
        
        if ($(this).attr('href') === '#Home') {
            // do nothing for now
        } else if ($(this).attr('href') === '#Adversary-pane') {
            retrieveAdversary();
        } else if ($(this).attr('href') === '#Document-pane') {
            retrieveDocument();
        } else if ($(this).attr('href') === '#Email-pane') {
            retrieveEmail();
        } else if ($(this).attr('href') === '#Group-pane') {
            retrieveGroup();
        } else if ($(this).attr('href') === '#Incident-pane') {
            retrieveIncident();
        } else if ($(this).attr('href') === '#Indicator-pane') {
            retrieveIndicator();
            map = createMap('map');
        } else if ($(this).attr('href') === '#map-tab') {
            var data, geoIpUrl;
            map.invalidateSize(false);
            
            // load ip points on map
            tc.indicators()
                .owner($('#Owner-select :selected').text())
                .resultLimit(500)
                .pagination(function(response) {
                    
                    for (data in response.data) {
                        var ip = response.data[data].indicators;
                        geoIpUrl =  'https://www.telize.com/geoip/' + ip + '?callback=?';
                        
	                    $.getJSON(geoIpUrl, function() {
	                        console.log("success");
	                    })
	                    .always(function(data) {
	                        console.log("complete", data);
	                        if (data.latitude && data.longitude) {
	                            L.marker([data.latitude, data.longitude]).addTo(map)
                                    .bindPopup(data.ip)
                                    .openPopup();
                            }
	                    });
                    }
                })
                .done(function(response) {
                })
                .error(function(response) {
                    var message =  'Incident Retrieval failed. (' + response + ').';
                    statusAlert('danger', message);
                })
                .retrieve({type: TYPE.ADDRESS});
            
            // load host points on map
            tc.indicators()
                .owner($('#Owner-select :selected').text())
                .resultLimit(500)
                .pagination(function(response) {
                    
                    for (data in response.data) {
                        var host = response.data[data].indicators;
                        geoIpUrl =  'https://freegeoip.net/json/' + host + '?callback=';
                        
	                    $.getJSON(geoIpUrl, function() {
	                        console.log("success");
	                    })
	                    .always(function(data) {
	                        console.log("complete", data);
	                        console.log("complete", data.longitude);
	                        console.log("complete", data.latitude);
	                        L.marker([data.latitude, data.longitude]).addTo(map)
                                .bindPopup(data.ip)
                                .openPopup();

	                    });
                    }
                })
                .done(function(response) {
                })
                .error(function(response) {
                    var message =  'Incident Retrieval failed. (' + response + ').';
                    statusAlert('danger', message);
                })
                .retrieve({type: TYPE.HOST});
        } else if ($(this).attr('href') === '#Owner-pane') {
            retrieveOwner();
        }
        return false;
    });
    
    // adversary
    $('#Adversary-clear').click(function(e) {
        c.log('clearing adversary table');
        $('#Adversary-table').bootstrapTable('removeAll');
    });
    
    $('#Adversary-commit').click(function(e){
        c.log('commiting adversary');
        // e.stopPropagation();
        commitAdversary();
        return false;
    });
    
    $('#Adversary-delete').click(function(e){
        c.log('deleteing adversaries');
        deleteAdversary();
    });
    
    $('#Adversary-refresh').click(function(e){
        c.log('refreshing adversaries');
        $('#Adversary-table').bootstrapTable('removeAll');
        retrieveAdversary();
    });
    
    // document
    $('#Document-clear').click(function(e){
        c.log('clearing document table');
        $('#Document-table').bootstrapTable('removeAll');
    });
    
    $('#Document-commit').click(function(e){
        c.log('commiting Document');
        commitDocument();
        return false;
    });
    
    $('#Document-delete').click(function(e){
        c.log('deleteing Documents');
        deleteDocument();
    });
    
    $('#Document-refresh').click(function(e){
        c.log('refreshing Documents');
        $('#Document-table').bootstrapTable('removeAll');
        retrieveDocument();
    });
    
    // email
    $('#Email-clear').click(function(e){
        c.log('clearing email table');
        $('#Email-table').bootstrapTable('removeAll');
    });
    
    $('#Email-commit').click(function(e){
        c.log('commiting email');
        commitEmail();
        return false;
    });
    
    $('#Email-delete').click(function(e){
        c.log('deleteing emails');
        deleteEmail();
    });
    
    $('#Email-refresh').click(function(e){
        c.log('refreshing emails');
        $('#Email-table').bootstrapTable('removeAll');
        retrieveEmail();
    });
    
    // group
    $('#Group-clear').click(function(e){
        c.log('clearing group table');
        $('#Group-table').bootstrapTable('removeAll');
    });
    
    $('#Group-refresh').click(function(e){
        c.log('refreshing groups');
        $('#Group-table').bootstrapTable('removeAll');
        retrieveGroup();
    });
    
    // incident
    $('#Incident-clear').click(function(e){
        c.log('clearing incident table');
        $('#Incident-table').bootstrapTable('removeAll');
    });
    
    $('#Incident-commit').click(function(e){
        c.log('commiting incidents');
        commitIncident();
        return false;
    });
    
    $('#Incident-delete').click(function(e){
        c.log('deleteing incidents');
        deleteIncident();
    });
    
    $('#Incident-refresh').click(function(e){
        c.log('refreshing incidents');
        $('#Incident-table').bootstrapTable('removeAll');
        retrieveIncident();
    });
    
    // indicator
    $('#Indicator-clear').click(function(e){
        c.log('clearing indicator table');
        $('#Indicator-table').bootstrapTable('removeAll');
    });
    
    $('#Indicator-commit').click(function(e){
        c.log('commiting indicators');
        commitIndicator();
        return false;
    });
    
    $('#Indicator-delete').click(function(e){
        c.log('deleteing indicators');
        deleteIndicator();
    });
    
    $('#Indicator-refresh').click(function(e){
        c.log('refreshing indicators');
        $('#Indicator-table').bootstrapTable('removeAll');
        retrieveIndicator();
    });
    
    // owner
    $('#Owner-clear').click(function(e){
        c.log('clearing owner table');
        $('#Owner-table').bootstrapTable('removeAll');
    });
    
    $('#Owner-refresh').click(function(e){
        c.log('refreshing owners');
        $('#Owner-table').bootstrapTable('removeAll');
        retrieveOwner();
    });
    
    //
    // Commit
    //
    var commitAdversary = function() {
        var message,
            name = $('#Adversary-name').val();
        
        tc.groups()
            .owner($('#Owner-select :selected').text())
            .type(TYPE.ADVERSARY)
            .name(name)
            .done(function(response) {
                if (response.status === "Success") {
                    message =  'Adversary ' + name + ' was successfully committed.';
                    statusAlert('success', message);
                    increaseCount('Adversary');
                }
            })
            .error(function(response) {
                var message =  'Adversary failed to committed. (' + response.error + ').';
                statusAlert('danger', message);
            })
            .pagination(function(response) {
                if (response.data.length > 0) {
                    c.log('pagination response', response);
                    $('#Adversary-table').bootstrapTable('append', response.data);
                }
            })
            .commit();
        $('#Adversary-modal').modal('hide');
    };
    
    var commitDocument = function() {
        var message,
            name = $('#Document-name').val(),
            fileName = $('#file-name').val(),
            fileSize = $('#file-size').val();
        
        tc.groups()
            .owner($('#Owner-select :selected').text())
            .type(TYPE.DOCUMENT)
            .name(name)
            .fileName(fileName)
            .fileSize(fileSize)
            .done(function(response) {
                if (response.status === "Success") {
                    message =  'Document ' + name + ' was successfully committed.';
                    statusAlert('success', message);
                    increaseCount('Document');
                }
            })
            .error(function(response) {
                message =  'Document failed to committed. (' + response.error + ').';
                statusAlert('danger', message);
            })
            .pagination(function(response) {
                if (response.data.length > 0) {
                    $('#Document-table').bootstrapTable('append', response.data);
                }
            })
            .commit();
        $('#Document-modal').modal('hide');
    };
    
    var commitEmail = function() {
        var message,
            name = $('#Email-name').val(),
            emailBody = $('#Email-body').val(),
            emailFrom = $('#Email-from').val(),
            emailHeader = $('#Email-header').val(),
            emailScore = $('#Email-score').val(),
            emailSubject = $('#Email-subject').val(),
            emailTo = $('#Email-to').val();
        
        tc.emails()
            .owner($('#Owner-select :selected').text())
            .type(TYPE.EMAIL)
            .name(name)
            .emailBody(emailBody)
            .emailFrom(emailFrom)
            .emailHeader(emailHeader)
            .emailScore(emailScore)
            .emailSubject(emailSubject)
            .emailTo(emailTo)
            .done(function(response) {
                if (response.status === "Success") {
                    message =  'Email ' + name + ' was successfully committed.';
                    statusAlert('success', message);
                    increaseCount('Email');
                }
            })
            .error(function(response) {
                message =  'Email failed to committed. (' + response.error + ').';
                statusAlert('danger', message);
            })
            .pagination(function(response) {
                if (response.data.length > 0) {
                    $('#Email-table').bootstrapTable('append', response.data);
                }
            })
            .commit();
        $('#Email-modal').modal('hide');
    };
    
    var commitIncident = function() {
        var message, 
            name = $('#Incident-name').val();
            
        tc.incidents()
            .owner($('#Owner-select :selected').text())
            .type(TYPE.INCIDENT)
            .name(name)
            .done(function(response) {
                if (response.status === "Success") {
                    message =  'Incident ' + name + ' was successfully committed.';
                    statusAlert('success', message);
                    increaseCount('Incident');
                }
            })
            .error(function(response) {
                var message =  'Incident failed to committed. (' + response.error + ').';
                statusAlert('danger', message);
            })
            .pagination(function(response) {
                if (response.data.length > 0) {
                    $('#Incident-table').bootstrapTable('append', response.data);
                }
            })
            .commit();
        $('#Incident-modal').modal('hide');
    };
    
    var commitIndicator = function() {
        var message,
            indicator = $('#Indicator-value').val(),
            indicatorType = $('#Indicator-type').val();
            
        tc.indicators()
            .owner($('#Owner-select :selected').text())
            .action('Create') // Create|Delete
            .attributeWriteType('Append')  // Append|Replace
            .haltOnError(false)
            .done(function(response) {
                if (response.status === "Success") {
                    message =  'Indicator ' + indicator + ' was successfully committed.';
                    statusAlert('success', message);
                    increaseCount('Indicator');
                    
                    $('#Indicator-table').bootstrapTable('removeAll');
                    retrieveIndicator();
                }
            })
            .error(function(response) {
                c.log('error');
                message =  'Indicator failed to committed. (' + response.error + ').';
                statusAlert('danger', message);
            })
            // bcs
            .indicator(indicator)
            .type(TYPE[indicatorType])
            // .indicator('1.2.3.8')
            // .type(TYPE.ADDRESS)
            .attributes([{type: 'Description', value: 'JS SDK Test'}])
            .tags(['JavaScript', 'SDK'])
            .add()
            .commit();
        $('#Indicator-modal').modal('hide');
    };
    
    //
    // Update
    //
    var updateAdversary = function(params) {
        var message;
        
        tc.groups()
            .owner($('#Owner-select :selected').text())
            .type(TYPE.ADVERSARY)
            .id(params.id)
            .name(params.name)
            .done(function(response) {
                if (response.status === "Success") {
                    message =  'Adversary ' + params.name + ' was successfully updated.';
                    statusAlert('success', message);
                }
            })
            .error(function(response) {
                var message =  'Adversary failed to update. (' + response.error + ').';
                statusAlert('danger', message);
            })
            .commit();
        $('#Adversary-modal').modal('hide');
    };
    
    var updateDocument = function(params) {
        var message;
        
        tc.groups()
            .owner($('#Owner-select :selected').text())
            .type(TYPE.TYPE.DOCUMENT)
            .id(params.id)
            .name(params.name)
            .done(function(response) {
                if (response.status === "Success") {
                    message =  'Document ' + params.name + ' was successfully updated.';
                    statusAlert('success', message);
                }
            })
            .error(function(response) {
                var message =  'Document Update failed. (' + response + ').';
                if (response.error) {
                    message =  'Document Update failed. (' + response.error + ').';
                }
                statusAlert('danger', message);
            })
            .commit();
    };
    
    var updateIncident = function(params) {
        var message;
        
        tc.groups()
            .owner($('#Owner-select :selected').text())
            .type(TYPE.TYPE.INCIDENT)
            .id(params.id)
            .name(params.name)
            .done(function(response) {
                if (response.status === "Success") {
                    message =  'Incident ' + params.name + ' was successfully updated.';
                    statusAlert('success', message);
                }
            })
            .error(function(response) {
                c.log('errrrrrrrrrrrrror', response);
                var message =  'Incident Update failed. (' + response + ').';
                if (response.error) {
                    message =  'Incident Update failed. (' + response.error + ').';
                }
                statusAlert('danger', message);
            })
            .commit();
    };
    
    //
    // Delete
    //
    var deleteAdversary = function() {
        var message,
            adversary_table = $('#Adversary-table'),
            selection,
            selections = adversary_table.bootstrapTable('getSelections');
            
        for (selection in selections) {
            selection = selections[selection];
            tc.groups()
                .owner($('#Owner-select :selected').text())
                .type(TYPE.ADVERSARY)
                .id(selection.id)
                .done(function(response) {
                    c.log('response', response);
                    if (response.status === 'Success') {
                        adversary_table.bootstrapTable('remove', {
                            field: 'id',
                            values: [response.id]
                        });
                        message =  'Adversary ' + response.id + ' was successfully deleted.';
                        statusAlert('success', message);
                        decreaseCount('Adversary');
                        
                    } else {
                        message =  'Adversary ' + response.id + ' failed to deleted.';
                        statusAlert('danger', message);
                    }
                })
                .error(function(response) {
                    message =  'Adversary ID ' + response.id + ' failed to delete. (' + response.error + ').';
                    statusAlert('danger', message);
                })
                .delete();
        }
    };
    
    var deleteDocument = function() {
        var message,
            document_table = $('#Document-table'),
            selection,
            selections =  document_table.bootstrapTable('getSelections');
            
        for (selection in selections) {
            selection = selections[selection];
            tc.groups()
                .owner($('#Owner-select :selected').text())
                .type(TYPE.TYPE.DOCUMENT)
                .id(selection.id)
                .done(function(response) {
                    if (response.status === 'Success') {
                        document_table.bootstrapTable('remove', {
                            field: 'id',
                            values: [response.id]
                        });
                        message =  'Document ' + response.id + ' was successfully deleted.';
                        statusAlert('success', message);
                        decreaseCount('Document');
                        
                    } else {
                        message =  'Document ' + response.id + ' failed to deleted.';
                        statusAlert('danger', message);
                    }
                })
                .error(function(response) {
                    message =  'Indicator ID ' + response.id + ' failed to delete. (' + response.error + ').';
                    statusAlert('danger', message);
                })
                .delete();
        }
    };
    
    var deleteEmail = function() {
        var message,
            email_table = $('#Email-table'),
            selection,
            selections =  email_table.bootstrapTable('getSelections');
            
        for (selection in selections) {
            selection = selections[selection];
            tc.groups()
                .owner($('#Owner-select :selected').text())
                .type(TYPE.EMAIL)
                .id(selection.id)
                .done(function(response) {
                    if (response.status === 'Success') {
                        email_table.bootstrapTable('remove', {
                            field: 'id',
                            values: [response.id]
                        });
                        message =  'Email ' + response.id + ' was successfully deleted.';
                        statusAlert('success', message);
                        decreaseCount('Email');
                    } else {
                        message =  'Email ' + response.id + ' failed to deleted.';
                        statusAlert('danger', message);
                    }
                })
                .error(function(response) {
                    message =  'Email ID ' + response.id + ' failed to delete. (' + response.error + ').';
                    statusAlert('danger', message);
                })
                .delete();
        }
    };
    
    var deleteIncident = function() {
        var message,
            incident_table = $('#Incident-table'),
            selection,
            selections =  incident_table.bootstrapTable('getSelections');
            
        for (selection in selections) {
            selection = selections[selection];
            tc.incidents()
                .owner($('#Owner-select :selected').text())
                .type(TYPE.INCIDENT)
                .id(selection.id)
                .done(function(response) {
                    if (response.status === 'Success') {
                        incident_table.bootstrapTable('remove', {
                            field: 'id',
                            values: [response.id]
                        });
                        message =  'Incident ' + response.id + ' was successfully deleted.';
                        statusAlert('success', message);
                        decreaseCount('Email');
                    } else {
                        message =  'Incident ' + response.id + ' failed to deleted.';
                        statusAlert('danger', message);
                    }
                })
                .error(function(response) {
                    var message =  'Incident ID ' + response.id + ' failed to delete. (' + response.error + ').';
                    statusAlert('danger', message);
                })
                .delete();
        }
    };
    
    var deleteIndicator = function() {};
        
    //
    // Retrieve
    //
    var retrieveAdversary = function() {
        c.log('retrieve adversaries');
        tc.groups()
            .owner($('#Owner-select :selected').text())
            .type(TYPE.ADVERSARY)
            .resultLimit(500)
            .pagination(function(response) {
                var d;
                if (response.data.length > 0) {
                    for (d in response.data) {
                        var data = response.data[d];
                        data.name = genEditSpan(data.id, data.name);
                    }
                    $('#Adversary-table').bootstrapTable('append', response.data);
                }
            })
            .done(function(response) {
                c.log('adversary retrieve done', response);
                $('#Adversary-content').text(JSON.stringify(response, null, 4));
                $('#Adversary-table').bootstrapTable('refreshOptions', {
                    sortName: 'id',
                    sortOrder: 'asc',
                    // data: response.data
                });
                setCount('Adversary', response.resultCount);
                tableActions('Adversary');
                enableForm('Adversary');
            })
            .error(function(response) {
                var message =  'Adversary Retrieval failed. (' + response + ').';
                statusAlert('danger', message);
            })
            .retrieve();
    };
    
    var retrieveDocument = function() {
        c.log('retrieve documents');
        tc.groups()
            .owner($('#Owner-select :selected').text())
            .resultLimit(500)
            .type(TYPE.DOCUMENT)
            .pagination(function(response) {
                if (response.data.length > 0) {
                    $('#Document-table').bootstrapTable('append', response.data);
                }
            })
            .done(function(response) {
                $('#Document-content').text(JSON.stringify(response, null, 4));
                $('#Document-table').bootstrapTable('refreshOptions', {
                    sortName: 'id',
                    sortOrder: 'asc',
                    // data: response.data
                });
                setCount('Document', response.resultCount);
            })
            .error(function(response) {
                var message =  'Document Retrieval failed. (' + response + ').';
                statusAlert('danger', message);
            })
            .retrieve();
    };
    
    var retrieveEmail = function() {
        c.log('retrieve emails');
        tc.groups()
            .owner($('#Owner-select :selected').text())
            .resultLimit(500)
            .type(TYPE.EMAIL)
            .pagination(function(response) {
                if (response.data.length > 0) {
                    $('#Email-table').bootstrapTable('append', response.data);
                }
            })
            .done(function(response) {
                $('#Email-content').text(JSON.stringify(response, null, 4));
                $('#Email-table').bootstrapTable('refreshOptions', {
                    sortName: 'id',
                    sortOrder: 'asc',
                    data: response.data
                });
                setCount('Email', response.resultCount);
            })
            .error(function(response) {
                var message =  'Email Retrieval failed. (' + response + ').';
                statusAlert('danger', message);
            })
            .retrieve();
    };
    
    var retrieveGroup = function() {
        c.log('retrieve groups');
            tc.groups()
                .owner($('#Owner-select :selected').text())
                .resultLimit(500)
                .pagination(function(response) {
                    c.log('response', response);
                    if (response.data.length > 0) {
                        $('#Group-table').bootstrapTable('append', response.data);
                    }
                })
                .done(function(response) {
                    $('#Group-content').text(JSON.stringify(response, null, 4));
                    $('#Group-table').bootstrapTable('refreshOptions', {
                        sortName: 'id',
                        sortOrder: 'asc',
                        data: response.data
                    });
                    setCount('Group', response.resultCount);
                })
                .error(function(response) {
                    var message =  'Group Retrieval failed. (' + response + ').';
                    statusAlert('danger', message);
                })
                .retrieve();
    };
    
    var retrieveIncident = function() {
        c.log('retrieve incidents');
        tc.groups()
            .owner($('#Owner-select :selected').text())
            .resultLimit(500)
            .type(TYPE.INCIDENT)
            .pagination(function(response) {
                var d;
                if (response.data.length > 0) {
                    for (d in response.data) {
                        var data = response.data[d];
                        data.name = genEditSpan(data.id, data.name);
                    }
                    $('#Incident-table').bootstrapTable('append', response.data);
                }
            })
            .done(function(response) {
                $('#Incident-content').text(JSON.stringify(response, null, 4));
                $('#Incident-table').bootstrapTable('refreshOptions', {
                    sortName: 'id',
                    sortOrder: 'asc',
                    // data: response.data
                });
                setCount('Incident', response.resultCount);
                tableActions('Incident');
                enableForm('Incident');
            })
            .error(function(response) {
                var message =  'Incident Retrieval failed. (' + response + ').';
                statusAlert('danger', message);
            })
            .retrieve();
    };
    
    var retrieveIndicator = function() {
        c.log('retrieve indicator');
            tc.indicators()
                .owner($('#Owner-select :selected').text())
                .resultLimit(500)
                .pagination(function(response) {
                    if (response.data.length > 0) {
                        $('#Indicator-table').bootstrapTable('append', response.data);
                    }
                })
                .done(function(response) {
                    $('#Indicator-content').text(JSON.stringify(response, null, 4));
                    $('#Indicator-table').bootstrapTable('refreshOptions', {
                        sortName: 'id',
                        sortOrder: 'asc',
                        data: response.data
                    });
                    setCount('Indicator', response.resultCount);
                })
                .error(function(response) {
                    var message =  'Indicator Retrieval failed. (' + response.error + ').';
                    statusAlert('danger', message);
                })
                .retrieve();
                // .retrieve({type: TYPE.FILE});
    };
    
    var retrieveOwner = function() {
        c.log('retrieve owners');
        tc.owners()
                .done(function(response) {
                    c.log('owner retrieve done');
                    $('#Owner-content').text(JSON.stringify(response, null, 4));
                    $('#Owner-table').bootstrapTable('refreshOptions', {
                        sortName: 'id',
                        sortOrder: 'asc',
                        data: response.data
                    });
                })
                .error(function(response) {
                    var message =  'Owner Retrieval failed. (' + response + ').';
                    statusAlert('danger', message);
                })
                .retrieve();
    };
    
    //
    // Retrieve Associations
    //
    var retrieveAssociations = function(params) {
        c.log('retrieve adversaries');
        tc.groups()
            .owner($('#Owner-select :selected').text())
            .type(params.groupType)
            // .id(params.id)
            .id(1)
            .resultLimit(500)
            .done(function(response) {
                c.log('adversary retrieve done', response);
                $('#Association-content').text(JSON.stringify(response, null, 4));
            })
            .error(function(response) {
                var message =  'Adversary Retrieval failed. (' + response + ').';
                statusAlert('danger', message);
            })
            .retrieveAssociations({type: params.type});
    };
    
    //
    // Upload
    //
    $('#Document-upload').click(function(e) {
        c.group('document-upload');
        var document_table = $('#Document-table'),
            file_input = $('#Document-file'),
            selections =  document_table.bootstrapTable('getSelections');
            
            c.log('file_input', file_input);
        
        if (selections.length == 0) {
            c.warn('at least one document must be selected.');
            return;
        } else if (selections.length > 1) {
            c.warn('only one upload at a time is supported.');
            document_table.bootstrapTable('uncheckAll');
            return;
        }
            
        file_input.click();
        file_input.on('change', function(){
            var file = file_input[0].files[0],
                selection = selections[0],
                id = selection.id,
                fr = new FileReader();
                
            fr.readAsText(file);
            fr.onload = function(data) {
                c.log('fr.result', fr.result);
                tc.upload()
                    .owner($('#Owner-select :selected').text())
                    .body(fr.result)
                    .id(id)
                    .done(function(response) {
                        statusAlert('success', 'Upload successful.');
                    })
                    .error(function(response) {
                        var message =  'Upload failed. (' + response.error + ').';
                        statusAlert('danger', message);
                    })
                    .commit();
            };
        });
        
        c.groupEnd();
    });
    
    $('#api-method a').click( function () {
        var apiUri = $('#api-uri').val(),
            body = $('#api-body').val(),
            method = $(this).text(),
            ro = new RequestObject(),
            formActivityLog = getParameterFromUri('activityLog', apiUri),
            formOwner = getParameterFromUri('owner', apiUri),
            formResultLimit = getParameterFromUri('resultLimit', apiUri),
            formResultStart = getParameterFromUri('resultStart', apiUri),
            uri = apiUri.split("?")[0].replace('/', '');
            
        c.log('formOwner', formOwner);
        
            
        var activityLog = formActivityLog || false,
            roOwner = formOwner || $('#Owner-select :selected').text(),
            resultLimit = formResultLimit || 500,
            resultStart = formResultStart || 0;
            
        /*
        c.log('URI', apiUri);
        c.log('Method', $(this).text());
        c.log('activityLog', activityLog);
        c.log('owner', roOwner);
        */
        
        ro.owner(roOwner)
            .activityLog(activityLog)
            .done(function(response) {
                c.log('api response', response);
                $('#api-content').text(JSON.stringify(response, null, 4));
            })
            .error(function(response) {
                $('#api-content').text(JSON.stringify(response, null, 4));
            })
            .requestUri(uri)
            .requestMethod(method)
            .resultLimit(resultLimit)
            .resultStart(resultStart);
            
        if (method === 'POST' || method === 'PUT') {
            
            if (body.length > 0) {
                ro.body(JSON.parse(body));
            } else {
                $('#api-content').text(JSON.stringify({error: 'Body must not be empty.'}, null, 4));
            }
        }
        c.log('ro', ro);
        
        tc.apiRequest(ro);
    });
    
    var statusAlert = function(type, message) {
        var alertDiv = $('<div></div>')
            .addClass('alert alert-' + type)
            .attr('data-dismiss', 'alert')
            .text(message);
        $('#alert-status').append(alertDiv);
    };
    
    var createMap = function(mapId) {
        c.log('createMap', mapId);
            
    	// var map = L.map('map').setView([0, 0], 2);
    	var map = L.map(mapId).setView([0, 0], 2);

    	L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6IjZjNmRjNzk3ZmE2MTcwOTEwMGY0MzU3YjUzOWFmNWZhIn0.Y8bhBaUMqFiPrDRW9hieoQ', {
    	    maxZoom: 18,
    	    attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
    	        '<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
    	        'Imagery  <a href="http://mapbox.com">Mapbox</a>',
    	    id: 'mapbox.streets'
    	}).addTo(map);

    	return map;
    };
    
    var increaseCount = function(type) {
        var pane = $('.nav.navbar-nav li a[href="#' + type + '-pane"] span'),
            count = parseInt(pane.text(), 10) + 1;
        pane.text(count);
    };
    
    var decreaseCount = function(type) {
        var pane = $('.nav.navbar-nav li a[href="#' + type + '-pane"] span'),
            count = parseInt(pane.text(), 10) - 1;
        pane.text(count);
    };
    
    var setCount = function(type, count) {
        var pane = $('.nav.navbar-nav li a[href="#' + type + '-pane"] span');
        pane.text(count);
    };
    
    var tableActions = function(type) {
        $('#' + type + '-table')
        .on('sort.bs.table', function (e) {
            setTimeout(function() {
                enableForm(type);
            }, 200);
        })
        .on('page-change.bs.table', function (e, size, number) {
            setTimeout(function() {
                enableForm(type);
            }, 200);
        });
    };
    
    var enableForm = function(type) {
        $('.editName').editable();
        $('.editName').on('save', function(e, params){
            var updateMethod = window['update' + type];
            updateMethod({
                name: params.newValue,
                id: $(this)[0].id
            });
        });
    };
    
    var genEditSpan = function(id, name) {
        var iSpan = $('<span></span>')
            .addClass('editName')
            .attr('id', id)
            .text(name);
        return iSpan[0].outerHTML;
    };
    // var tableForm = function(table) {
    //     c.log('tableForm', table);
                    
    //     var idIndex = $('#' + table + '-table tr').find('[data-field="id"]').index();
    //     c.log('idIndex', idIndex);
    //     var nameIndex = $('#' + table + '-table tr').find('[data-field="name"]').index();
    //     c.log('nameIndex', nameIndex);
    //     $('#' + table + '-table tr').each(function() {
    //         var id = $(this).find('td').eq(idIndex).html();
    //         c.log('id', id);
    //         var name = $(this).find('td').eq(nameIndex);
    //         name.html('<span id="' + id + '" class="editName">' + name.html() + '</span>');
    //         c.log('td name', name.html());
    //     });
        
    //     $('.editName').editable();
    //     $('.editName').on('save', function(e, params){
    //         var updateMethod = window['commit' + table];
    //         updateMethod({
    //             name: params.newValue,
    //             id: $(this)[0].id
    //         });
    //         // c.log('saving e', e);
    //         // c.log('saving params', params);
    //         // c.log('saving this', $(this)[0].id);
    //     });
    // };
    
    function manualRequest(params) {
        var ro = new RequestObject();
        
        ro.owner(params.owner)
            .done(params.done)
            .error(params.error)
            .requestUri(params.uri)
            .requestMethod(params.method)
            .resultLimit(params.resultLimit);
            
        tc.apiRequest(ro);
    }
    
    function resourceCounts(uri, pane) {
        manualRequest({
            owner: $('#Owner-select :selected').text(),
            done: function(response) {
                setCount(pane, response.data.resultCount);
            },
            error: function(response) {
                var message =  'Manual Retrieval failed. (' + response + ').';
                statusAlert('danger', message);
            },
            uri: uri,
            method: 'GET',
            resultLimit: 1
        });
    }
    
    function retrieveIndicatorCount(pane) {
        tc.indicators()
            .owner($('#Owner-select :selected').text())
            .limit(1)
            .done(function(response) {
                setCount(pane, response.resultCount);
            })
            .error(function(response) {
                var message =  'Indicator Retrieval failed. (' + response.error + ').';
                statusAlert('danger', message);
            })
            .retrieve({type: TYPE.ADDRESS});
    }
    
</script>
</html>
